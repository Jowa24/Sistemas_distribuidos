# This file orchestrates your entire application

# Define a custom network for all services
networks:
  ev_network:
    driver: bridge

# FIX: Define a named volume for the database
volumes:
  db_data:

services:
  # --- 1. THE SERVER INSTANCE (Central, Kafka, DB) ---

  zookeeper:
    image: confluentinc/cp-zookeeper:7.6.1
    networks:
      - ev_network
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "2181"]
      interval: 10s
      timeout: 5s
      retries: 15

  kafka:
    image: confluentinc/cp-kafka:7.6.1
    networks:
      - ev_network
    depends_on:
      zookeeper:
        condition: service_healthy # Wait for Zookeeper
    ports:
      - "9092:29092" # Optional: Expose Kafka to your host machine
    environment:
      - KAFKA_BROKER_ID=1
      - KAFKA_ZOOKEEPER_CONNECT=zookeeper:2181
      - KAFKA_LISTENERS=PLAINTEXT://:29092
      - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://kafka:29092
      - KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=PLAINTEXT:PLAINTEXT
      - KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1
      - KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS=0
      - KAFKA_AUTO_CREATE_TOPICS_ENABLE=false # EV_Central will create topics
    healthcheck:
      test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:29092"]
      interval: 10s
      timeout: 5s
      retries: 15

  ev-central:
    build:
      context: .
      dockerfile: python.Dockerfile
    networks:
      - ev_network
    depends_on:
      kafka:
        condition: service_healthy # <-- Wait for Kafka
    volumes:
      # FIX: Mount the named volume as a directory
      - db_data:/app/db_data
    command: python3 EV_Central.py kafka:29092 8080
    ports:
      - "8080:8080"

  # --- 2. THE MACHINE INSTANCE (Engine + Monitor) ---

  cp1-engine:
    build:
      context: .
      dockerfile: python.Dockerfile
    networks:
      - ev_network
    depends_on:
      ev-central:
        condition: service_started
    # FIX: Removed 'location' argument
    command: python3 EV_CP_E.py 1 0.45 kafka:29092 cp1-engine:9001
    ports:
      - "9001:9001"
    stdin_open: true
    tty: true

  cp1-monitor:
    build:
      context: .
      dockerfile: python.Dockerfile
    networks:
      - ev_network
    depends_on:
      - ev-central
      - cp1-engine
    # FIX: Wait 5s, removed 'location' and 'price_kw'
    command: >
      sh -c "sleep 5 && 
             python3 EV_CP_M.py cp1-engine 9001 ev-central 8080 1"

  # --- 3. THE DRIVER INSTANCE ---

  driver-101:
    build:
      context: .
      dockerfile: python.Dockerfile
    networks:
      - ev_network
    depends_on:
      ev-central: 
        condition: service_started
    command: >
      sh -c "sleep 10 && # Wait 10s for system to be ready
             python3 EV_DRIVER.py 1,2 101 kafka:29092"

  # === SCALABILITY DEMO ===

  cp2-engine:
    build:
      context: .
      dockerfile: python.Dockerfile
    networks:
      - ev_network
    depends_on:
      ev-central:
        condition: service_started
    # FIX: Removed 'location' argument
    command: python3 EV_CP_E.py 2 0.55 kafka:29092 cp2-engine:9002
    ports:
      - "9002:9002"
    stdin_open: true
    tty: true

  cp2-monitor:
    build:
      context: .
      dockerfile: python.Dockerfile
    networks:
      - ev_network
    depends_on:
      - ev-central
      - cp2-engine
    # FIX: Wait 5s, removed 'location' and 'price_kw'
    command: >
      sh -c "sleep 5 &&
             python3 EV_CP_M.py cp2-engine 9002 ev-central 8080 2"

  driver-102:
    build:
      context: .
      dockerfile: python.Dockerfile
    networks:
      - ev_network
    depends_on:
      ev-central:
        condition: service_started
    command: >
      sh -c "sleep 12 && # Stagger the drivers
             python3 EV_DRIVER.py 2 102 kafka:29092"
             
  # --- 4. DEBUGGING TOOL ---

  kafka-debugger: # <--- CORRECT: Now at the same level as other services
    build:
      context: .
      dockerfile: python.Dockerfile
    networks:
      - ev_network
    depends_on:
      kafka:
        condition: service_healthy
    command: python3 kafka_debug_tool.py kafka:29092
